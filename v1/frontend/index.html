<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FoodLens - Digital Menu</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    .dish-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
    }

    .dish-card img {
      max-width: 100%;
      border-radius: 6px;
      margin-top: 8px;
    }

    .category-title {
      margin-top: 30px;
      font-size: 1.5rem;
      color: #333;
    }

    #menu-output h2 {
      margin-top: 40px;
    }

    button {
      padding: 8px 12px;
      border: none;
      background: #0077cc;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #005fa3;
    }

    input[type="file"], select {
      margin-bottom: 10px;
    }

    /* Flex container for side-by-side output */
    #results-container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    #ocr-output, #vision-output {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      min-height: 300px;
      overflow-y: auto;
      background: #fafafa;
    }
  </style>
</head>
<body>
  <h2>Upload a menu image</h2>

  <!-- File input -->
  <input type="file" id="image-input" accept="image/*" />
  <button id="scan-btn">Scan Menu (Both Methods)</button>

  <!-- Side-by-side outputs -->
  <div id="results-container">
    <div>
      <h3>OCR + LLM Result</h3>
      <div id="ocr-output"></div>
    </div>
    <div>
      <h3>Vision LLM Result</h3>
      <div id="vision-output"></div>
    </div>
  </div>

<script>
  function renderMenu(outputElement, structured) {
    outputElement.innerHTML = "";

    if (!structured || !Array.isArray(structured.categories) || structured.categories.length === 0) {
      outputElement.innerHTML = "<p style='color:red'>Invalid structured data. Check backend output.</p>";
      console.warn("⚠️ No valid categories returned.");
      return;
    }

    if (structured.restaurant_name) {
      const title = document.createElement('h2');
      title.textContent = structured.restaurant_name;
      outputElement.appendChild(title);
    }

    for (const category of structured.categories) {
      const catTitle = document.createElement('h3');
      catTitle.className = "category-title";
      catTitle.textContent = category.name || "Unnamed Category";
      outputElement.appendChild(catTitle);

      for (const item of category.items || []) {
        const card = document.createElement('div');
        card.className = "dish-card";

        const name = document.createElement('h4');
        name.textContent = item.name || "Unnamed item";

        const desc = document.createElement('p');
        desc.textContent = item.description || "No description available.";

        const price = document.createElement('p');
        price.textContent = item.price ? `Price: ${item.price}` : "Price not listed";

        card.appendChild(name);
        card.appendChild(desc);
        card.appendChild(price);

        if (item.image_url && item.image_url.startsWith("http")) {
          const img = document.createElement('img');
          img.src = item.image_url;
          img.alt = item.name;
          img.onerror = () => img.remove();
          card.appendChild(img);
        }

        outputElement.appendChild(card);
      }
    }
  }

  document.getElementById('scan-btn').addEventListener('click', async () => {
    const input = document.getElementById('image-input');

    if (!input.files.length) {
      alert('Please upload a menu image.');
      return;
    }

    const formData = new FormData();
    formData.append('file', input.files[0]);

    const ocrOutput = document.getElementById('ocr-output');
    const visionOutput = document.getElementById('vision-output');

    // Show loading states
    ocrOutput.innerHTML = "<p>Scanning with OCR + LLM...</p>";
    visionOutput.innerHTML = "<p>Scanning with Vision LLM...</p>";

    // Endpoints
    const ocrEndpoint = "http://localhost:8000/api/extract";
    const visionEndpoint = "http://localhost:8000/api/vision-extract";

    try {
      // Run both requests in parallel
      const [ocrRes, visionRes] = await Promise.all([
        fetch(ocrEndpoint, { method: 'POST', body: formData }),
        fetch(visionEndpoint, { method: 'POST', body: formData })
      ]);

      const ocrData = await ocrRes.json();
      const visionData = await visionRes.json();

      renderMenu(ocrOutput, ocrData.structured);
      renderMenu(visionOutput, visionData.structured);

    } catch (err) {
      console.error("Error during fetch/render:", err);
      ocrOutput.innerHTML = "<p style='color:red'>Something went wrong. See console.</p>";
      visionOutput.innerHTML = "<p style='color:red'>Something went wrong. See console.</p>";
    }
  });
</script>
</body>
</html>
