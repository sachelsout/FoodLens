<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FoodLens - Digital Menu</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    .dish-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
    }

    .dish-card img {
      max-width: 100%;
      border-radius: 6px;
      margin-top: 8px;
    }

    .category-title {
      margin-top: 30px;
      font-size: 1.5rem;
      color: #333;
    }

    #menu-output h2 {
      margin-top: 40px;
    }

    button {
      padding: 8px 12px;
      border: none;
      background: #0077cc;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #005fa3;
    }

    input[type="file"] {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h2>Upload a menu image</h2>
  <input type="file" id="image-input" accept="image/*" />
  <button id="scan-btn">Scan Menu</button>

  <div id="menu-output"></div>

<script>
  document.getElementById('scan-btn').addEventListener('click', async () => {
    const input = document.getElementById('image-input');
    if (!input.files.length) {
      alert('Please upload a menu image.');
      return;
    }

    const formData = new FormData();
    formData.append('file', input.files[0]);

    const output = document.getElementById('menu-output');
    output.innerHTML = "<p>Scanning menu...</p>";
    console.log("üì§ Sending image to /api/extract");

    try {
      const res = await fetch('http://localhost:8000/api/extract', {
        method: 'POST',
        body: formData
      });

      console.log("üîÅ Response status:", res.status);
      const data = await res.json();
      console.log("üçΩÔ∏è Full API response:", data);

      const structured = data.structured || {};
      const categories = structured.categories || [];

      output.innerHTML = ""; // clear loading message

      if (!Array.isArray(categories) || categories.length === 0) {
        output.innerHTML = "<p style='color:red'>Invalid structured data. Check backend output.</p>";
        console.warn("‚ö†Ô∏è No valid categories returned.");
        return;
      }

      if (structured.restaurant_name) {
        const title = document.createElement('h2');
        title.textContent = structured.restaurant_name;
        output.appendChild(title);
      }

      for (const category of categories) {
        console.log("üìÇ Category:", category.name);

        const catTitle = document.createElement('h3');
        catTitle.className = "category-title";
        catTitle.textContent = category.name || "Unnamed Category";
        output.appendChild(catTitle);

        for (const item of category.items || []) {
          console.log("üç¥ Item:", item.name);

          const card = document.createElement('div');
          card.className = "dish-card";

          const name = document.createElement('h4');
          name.textContent = item.name || "Unnamed item";

          const desc = document.createElement('p');
          desc.textContent = item.description || "No description available.";

          const price = document.createElement('p');
          price.textContent = item.price ? `Price: ${item.price}` : "Price not listed";

          card.appendChild(name);
          card.appendChild(desc);
          card.appendChild(price);

          if (item.image_url && item.image_url.startsWith("http")) {
            try {
              const img = document.createElement('img');
              img.src = item.image_url;
              img.alt = item.name;
              img.onerror = () => {
                console.warn("‚ùå Failed to load image for", item.name);
                img.remove();
              };
              card.appendChild(img);
            } catch (imgErr) {
              console.error("üö´ Image append error:", imgErr);
            }
          } else {
            console.warn("‚ö†Ô∏è Missing or invalid image_url for:", item.name);
          }

          output.appendChild(card);
        }
      }
    } catch (err) {
      console.error("üî• Error during fetch/render:", err);
      output.innerHTML = "<p style='color:red'>Something went wrong. See console.</p>";
    }
  });
</script>
